<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>Project: Navigation Framework for Tableau Dashboards</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f9f9f9;
    }
    h1 {
      color: #333;
    }
    p {
      font-size: 1.1em;
      color: black;
    }
    img {
      max-width: 100%;
      height: auto;
      margin: 20px 0;
      border: 1px solid #ddd;
    }
    pre {
      background-color: #f4f4f4;
      padding: 10px;
      border: 1px solid #ddd;
      overflow-x: auto;
    }
    code {
      font-family: "Courier New", Courier, monospace;
      font-size: 0.9em;
      display: block;
    }
    h2 {
      color: #444;
      margin-top: 30px;
    }
    ul {
      list-style-type: disc; /* disc, circle, or square for bullet types */
      padding-left: 20px;
    }
    ul li {
      margin: 5px 0;
      color: darkgray;
    }
  </style>
</head>
<body>

  <h1>Project: Navigation Framework for Tableau Dashboards</h1>

  <p>Although you can always provide people with native links to Tableau server hosted dashboards, I instead developed a web application front end to provide easy
  navigation to the various Tableau dashboards. This project required:</p>

  <ul>
    <li>Setting up a Linux Server using Cisco's RunOn Service, where virtual machines can be requested</li>
    <li>Installing the necessary Apache web server software and configuration</li>
    <li>Obtaining and installing an SSL certificate to support secure https traffic</li>
    <li>Requesting a custom domain name for the server</li>
    <li>Using our internal version of ChatGPT to develop the necessary web site code</li>
  </ul>

  <p>The high level requirements for the web application were as follows:</p>

  <ul>
    <li>Custom URL for the site, e.g., https://&lt;our_team>&gt;.cisco.com</li>
    <li>Provide a configurable two-level menu system to navigate to specific reports</li>
    <li>Menus and dashboard URLs dynamically read from a csv file so no code required for updates</li>
    <li>Display a breadcrumb so the menu path taken for a given dashboard is shown</li>
    <li>Search box to find dashboards based on dashboard title or keywords</li>
    <li>Handle Single-Sign-On, redirecting to the Cisco SSO portal as needed and return back to site</li>
    <li>Implement Tableau Connected App feature to establish trust relationship between web server and Tableau server</li>
  </ul>

  <p>The project required the following elements:</p>

<ul>
  <li>HTML file: <a href="#html-section">index.html</a></li>
  <li>CSS file: <a href="#css-section">styles.css</a></li>
  <li>JavaScript file: <a href="#javascript-section">scripts.js</a></li>
  <li>PHP file: <a href="#php-section">menuData.php</a></li>
  <li>Application file: <a href="#application-section">apps.js</a></li>
  <li>CSV file to store the menus and dashboard URLs</li>
</ul>

  <h2>Screenshot</h2>
  <!-- Add the actual path to your screenshot here -->
  <img src="images/clpm_dashboard_1.jpg" alt="Tableau Navigation Framework">

<!-- ------------------------------------------------------------ -->	

  <h2 id="html-section">HTML Code</h2>
  <pre><code>    
&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;

&lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot;&gt;
    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;
    &lt;title&gt;Commerce Lifecycle Dashboard&lt;/title&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;styles.css&quot;&gt;
    &lt;link rel=&quot;icon&quot; href=&quot;img/clpt_small.png&quot;&gt;
    &lt;script type=&quot;module&quot; src=&quot;https://tableau.cisco.com/javascripts/api/tableau.embedding.3.latest.min.js&quot;&gt;&lt;/script&gt;
    &lt;script src=&quot;https://code.jquery.com/jquery-3.6.0.min.js&quot;&gt;&lt;/script&gt;
    &lt;script src=&quot;scripts.js&quot;&gt;&lt;/script&gt;
&lt;/head&gt;

&lt;body&gt;
    &lt;div id=&quot;menu&quot;&gt;
        &lt;!-- Logo --&gt;
        &lt;img src=&quot;img/clpm_logo_25.gif&quot; alt=&quot;CLPM Logo&quot; id=&quot;logo&quot;&gt;

        &lt;!-- Home Icon --&gt;
        &lt;a href=&quot;https://clpm-bi.cisco.com/&quot;&gt;
            &lt;img src=&quot;img/home_icon_2_24px.png&quot; alt=&quot;Home&quot; id=&quot;home-icon&quot;&gt;
        &lt;/a&gt;

        &lt;!-- Search Box --&gt;
        &lt;input type=&quot;text&quot; id=&quot;searchBox&quot; placeholder=&quot;Search reports...&quot; /&gt;
        &lt;div id=&quot;results&quot;&gt;&lt;/div&gt;

        &lt;!-- Email Icon --&gt;
        &lt;a href=&quot;mailto:clpm-bi@cisco.com&quot; id=&quot;email-icon&quot;&gt;
            &lt;img src=&quot;img/email_icon_24px.png&quot; alt=&quot;Email&quot;&gt;
        &lt;/a&gt;
    &lt;/div&gt;

    &lt;!-- Breadcrumb --&gt;
    &lt;div id=&quot;breadcrumb&quot;&gt;&lt;/div&gt;

    &lt;!-- Tableau Viz placeholder --&gt;
    &lt;div id=&quot;tableauViz&quot;&gt;&lt;/div&gt;

&lt;/body&gt;
&lt;/html&gt;
  </code></pre>

<!-- ------------------------------------------------------------ -->
	

<h2 id="css-section">CSS Code</h2>
<pre><code>

body {
    font-family: Arial, sans-serif;
}

#menu {
    background-color: #ffffff;
    padding-left: 5px;
	border-bottom: 2px solid #d3d3d3;
	position: relative;
}

#searchBox {
    position: absolute;
    right: 100px;
    top: 50%;
    transform: translateY(-30%);
}

#logo {
    height: 30px; 
    margin-right: 20px; 
    vertical-align: middle;
}

/* Top level dropdown */
.dropdown {
    color: black;  /* Font color set to black */
    position: relative;
    display: inline-block;
    margin-right: 30px;
    padding-top: 20px; /* Increase padding to remove any gap */
	vertical-align: bottom;
	line-height: inherit;
}

/* Top-level menu items */
.dropdown > a {
    color: black;  /* Font color set to black */
}

.dropdown > a.dropdown-trigger::after {
    color: gray;
    content: "â–¼";  /* Downward triangle character */
    margin-left: 5px; /* Space between the menu item and triangle */
    display: inline-block; 
    vertical-align: middle;
}

.dropdown:hover .dropdown-content {
    display: block;
	z-index: 4;
}


/* Top level dropdown content */
.dropdown-content {
	top: 40px; /* Adjust the value as needed */
    padding-top: 20px; /* Adjust the value as needed */
    display: none;
    position: absolute;
    background-color: #f2f2f2;
    z-index: 1;
    min-width: 300px;
}

.dropdown-content a[id^="dashboard"]:first-child {
    margin-top: 2px; /* Add margin to create space above the first second-level menu item */
}

.sub-menu-title {
	font-weight: bold;
    padding: 0px 6px; /* Adjusted padding */
    color: black;
    text-align: left;
	text-decoration: none !important;

}

/* Styles for report links under each sub-menu */
.dropdown-content a[id^="dashboard"] {
    color: black;
	padding: 6px 0px 6px 40px; /* Increase vertical separation */
    display: block;
}

a:hover {
    text-decoration: underline;
}

/* Prevent underline for top-level menu items on hover */
.dropdown > a:hover {
    text-decoration: none;
}

.dropdown:hover .dropdown-content a[id^="dashboard"] {
    background-color: #f2f2f2;
}

.dropdown:hover .dropdown-content a[id^="dashboard"]:hover {
    background-color: #e6e6e6;
}
#tableauViz {
    padding: 10px;
    width: 100%; /* Adjust as per your requirement */
    height: 2000px; /* Adjust based on the expected size of your tableau dashboard */
}

tableau-viz {
    justify-content: flex-start;
}

a {
    text-decoration: none;
    color: #007BFF;
    cursor: pointer;
}

a:hover {
    text-decoration: underline;
}
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

#email-icon {
    position: absolute;
    right: 20px;
    top: 50%;
    transform: translateY(-30%);
    color: black; /* Or whichever color you prefer */
}

#home-icon {
    height: 24px; 
    margin-right: 20px; 
    /*top: 100%;*/
    /*transform: translateY(35%);*/
    vertical-align: middle;
    color: black; /* Or whichever color you prefer */
}

a[href='https://clpm-bi.cisco.com/']:hover {
    text-decoration: none;
}

body.home-screen {
    background-color: #0d274c;
}

#breadcrumb {
    margin: 10px 0;  /* Adds space above and below the breadcrumb */
    font-size: 0.8em;  /* Makes the font smaller */
    color: gray;  /* Makes the text color gray */
    padding-left: 10px;  /* Adds some space to the left of the breadcrumb */
}

#results {
    position: absolute;
    right: 150px; /* align the right edge with the right edge of the searchBox */
    z-index: 1000; /* higher than the z-index (if any) of #tableauViz */
    top: 120%; /* position just below the searchBox */
    padding: 10px;
    max-height: 200px;
    overflow-y: auto;
    width: 600px; /* you can adjust this value to your needs */
}

.hasResults {
    border: 1px solid #ccc;
    background: white;
}

#results a {
    display: block;
    margin-bottom: 5px;
}
</code></pre>

<!-- ------------------------------------------------------------ -->
	

  <h2 id="javascript-section">JavaScript Code</h2>
  <pre><code>
var currentViz;  // This variable keeps track of the current visualization
var menuData; // This variable keeps track of the menu data

// Define global variables
let globalUrl;
let globalDashboardId;


// Fetch the menu data from the server when the page loads
window.addEventListener('DOMContentLoaded', function() {
	checkSessionAndFetchToken().then(result => {
        if (result.isValidSession) {
            console.log('Session is valid. Tableau Token:', result.tableauToken);
		    // Store the token in session storage
            sessionStorage.setItem('tableauToken', result.tableauToken);
            loadMenuAndDashboard();
        } else {
            console.log('Session is not valid.');
            // Handle the case when the session is not valid
		    redirectToAuthFlow();
        }
    });
});


// checkSession and return token--------------------------------------------------------------------------------------------------------------------
function checkSessionAndFetchToken() {
    // Use the relative URL to the server endpoint
    return fetch('/check-session', {credentials: 'include'})
        .then(response => {
            if (!response.ok) {
                throw new Error('Session check failed');
            }
            return response.json();
        })
        .then(data => {
            if (data.isValidSession) {
                // Session is valid and we have a Tableau token
                // Return an object containing the validity of the session
                // and the token itself
                return {
                    isValidSession: true,
                    tableauToken: data.tableauToken
                };
            } else {
                // Session is not valid
                return {
                    isValidSession: false,
                    tableauToken: null
                };
            }
        })
        .catch(error => {
            console.error('Error during session check:', error);
            return {
                isValidSession: false,
                tableauToken: null
            };
        });
}

function redirectToAuthFlow() {
    // Store the current URL so you can redirect back to it after authentication
    const currentUrl = encodeURIComponent(window.location.href);
    // Replace with the actual URL of your authentication flow
    window.location.href = `https://clpm-bi.cisco.com/auth?returnUrl=${currentUrl}`;
}


function showHomePage() {
    var body = document.body;
    var img = document.createElement('img');
    img.src = "img/clpm_home_screen.png";
    img.alt = "CLPM Home Screen";
    img.id = "homeImage"; // set an id so we can easily remove it later
    document.getElementById("tableauViz").appendChild(img);
    body.classList.add('home-screen'); // add the class
}

function retrieveNewToken(callback, errorCallback) {
    fetch('/get-new-token')
        .then(response => {
            if (!response.ok) {
                // If the response status code is not OK, call the error callback
                errorCallback(new Error(`HTTP error! status: ${response.status}`));
                return null; // Prevent further processing in the promise chain
            }
            return response.json();
        })
        .then(data => {
            if (data && data.tableauToken) {
                callback(data.tableauToken);
            } else {
                // If the data does not contain a tableauToken, call the error callback
                errorCallback(new Error('Failed to retrieve a new token'));
            }
        })
        .catch(error => {
            // Call the error callback for any other errors
            errorCallback(error);
        });
}

function handleLoadError(error) {
    console.log("tableauViz error detected!");
    retrieveNewToken(
        function(newToken) { // Success callback
            sessionStorage.setItem('tableauToken', newToken);
            initViz(globalUrl, globalDashboardId);
        },
        function(error) { // Error callback
            console.error('Failed to retrieve new token:', error);
            // If retrieving a new token fails, call checkSessionAndFetchToken instead
            checkSessionAndFetchToken().then(result => {
                if (result.isValidSession) {
                    console.log('Session is valid. Tableau Token:', result.tableauToken);
                    // Store the token in session storage
                    sessionStorage.setItem('tableauToken', result.tableauToken);
                    initViz(globalUrl, globalDashboardId);
                } else {
                    console.log('Session is not valid.');
                    // Handle the case when the session is not valid
                    redirectToAuthFlow();
                }
            });
        }
    );
}

// Load Menu and Dashboard ---------------------------------------------------------------------------------------------------
function loadMenuAndDashboard() {
    fetch('menuData.php')
        .then(response => response.json())
        .then(data => {
            menuData = data;
            generateMenuItems(menuData);

            var urlParams = new URLSearchParams(window.location.search);
            var dashboardId = urlParams.get('dashboardId');
            if (dashboardId) {
                loadDashboard(dashboardId);
            } else {
                showHomePage();
            }
        });
}

// Generate Menu Items Function ---------------------------------------------------------------------------------------------------
function generateMenuItems(menuData) {
    var menu = document.getElementById('menu');

    // Group the menu data by level 1 and level 2 categories
    var level1Categories = {};
    menuData.forEach(function(item) {
        if (item.INCLUDE_YORN === 'Y') { // Only add the item if INCLUDE_YORN is 'Y'
            if (!level1Categories[item.MENU_LEVEL_1]) {
                level1Categories[item.MENU_LEVEL_1] = {};
            }
            if (!level1Categories[item.MENU_LEVEL_1][item.MENU_LEVEL_2]) {
                level1Categories[item.MENU_LEVEL_1][item.MENU_LEVEL_2] = [];
            }
            level1Categories[item.MENU_LEVEL_1][item.MENU_LEVEL_2].push(item);
        }
    });

    // Generate the dropdowns
    for (var level1CategoryName in level1Categories) {
        var dropdown = document.createElement('div');
        dropdown.className = 'dropdown';

        var trigger = document.createElement('a');
        trigger.href = '#';
        trigger.className = 'dropdown-trigger';
        trigger.textContent = level1CategoryName;
        dropdown.appendChild(trigger);

        var content = document.createElement('div');
        content.className = 'dropdown-content';

        for (var level2CategoryName in level1Categories[level1CategoryName]) {
            var subMenuTitle = document.createElement('a');
            subMenuTitle.href = '#';
            subMenuTitle.className = 'sub-menu-title';
            subMenuTitle.textContent = level2CategoryName;
            content.appendChild(subMenuTitle);

            level1Categories[level1CategoryName][level2CategoryName].forEach(function(item) {
                var link = document.createElement('a');
                link.href = '#';
                link.id = item.REPORT_ID; // Replace 'id' with the actual column name in your CSV
                link.textContent = item.REPORT_NAME; // Replace 'title' with the actual column name in your CSV
                link.onclick = function() {
                    var breadcrumb = document.getElementById('breadcrumb');
                    breadcrumb.textContent = item.MENU_LEVEL_1 + ' > ' + item.MENU_LEVEL_2 + ' > ' + item.REPORT_NAME;
                    loadDashboard(item.REPORT_ID); // Replace 'id' with the actual column name in your CSV
                    return false;
                };
                content.appendChild(link);
            });
        }

        dropdown.appendChild(content);
        menu.appendChild(dropdown);
    }
}

// Load Dashboard Function ---------------------------------------------------------------------------------------------------------

function loadDashboard(dashboardId) {
    var homeImage = document.getElementById("homeImage");
    if (homeImage) {
        homeImage.parentNode.removeChild(homeImage);
    }
    document.body.classList.remove('home-screen'); // Remove the class

    var dashboard = menuData.find(function(item) {
        return item.REPORT_ID === dashboardId;		// Replace 'id' with the actual column name in your CSV
    });

    if (!dashboard) {
        console.error("Invalid dashboardId provided");
        return;
    }
	
	console.log('REPORT_ID aka dashboardId: ', dashboard.REPORT_ID);

    //var url = dashboard.REPORT_URL + "iframeSizedToWindow=true&:embed=true&:showAppBanner=false&:display_count=no&:showVizHome=no&:origin=viz_share_link&:toolbar=top"; // Replace 'url' with the actual column name in your CSV
    var url = dashboard.REPORT_URL; // Replace 'url' with the actual column name in your CSV
	// Check if the last character is a question mark and remove it
	//if (url.endsWith('?')) {
	//	url = url.slice(0, -1);
	//}
    
	console.log('function loadDashboard url =',url);

    initViz(url, dashboardId);

    // Update browser URL
    var newUrl = window.location.href.split('?')[0] + '?dashboardId=' + dashboardId;
    window.history.pushState({dashboardId: dashboardId}, '', newUrl);
}


// Initialize Viz Function ---------------------------------------------------------------------------------------------------------
function initViz(url, dashboardId) {
	// Store the URL and dashboardId for later use
    globalUrl = url;
    globalDashboardId = dashboardId;
	
	var containerDiv = document.getElementById("tableauViz");
	
	//containerDiv.addEventListener(TableauEventType.VizLoadError, handleCALoadError);
	
	//Retrieve the token from session storage
	const token = sessionStorage.getItem('tableauToken');

	if (!token) {
        console.error("Token is missing or expired");
        redirectToAuthFlow(); // Redirect to authentication if the token is missing
        return;
    }
	
    // If there's an existing visualization, we'll dispose of it before creating a new one.
    if (window.currentViz) {
		console.log('Removing currentViz');
        try {
			containerDiv.removeChild(currentViz);
		} catch (e) {
            console.error("Error disposing the viz", e);
        }
	}

	// Create a new <tableau-viz> element
	window.currentViz = document.createElement("tableau-viz");
    window.currentViz.setAttribute("id", "tableauViz");
	window.currentViz.setAttribute("src", url);
	window.currentViz.setAttribute("token", token); // Set the token attribute for authentication
	//currentViz.setAttribute("height", "100%");
	//currentViz.setAttribute("width", "100%");
	window.currentViz.setAttribute("toolbar", "Top");
	window.currentViz.setAttribute("tabs", "none");
	window.currentViz.setAttribute("onVizLoadError", "handleLoadError");
	window.currentViz.setAttribute("hide-tabs", "");
	
	// Append the <tableau-viz> element to the container
    console.log('currentViz: ', window.currentViz);
	containerDiv.appendChild(window.currentViz);
	
	
	// Listen for the first interactive event
    window.currentViz.addEventListener("firstinteractive", function() {
      console.log("Tableau dashboard loaded.");
	});
     

	 
    // Update browser URL when visualization is loaded
	//console.log('Update browser URL, url = ', url);
	//console.log('Extracted dashboardId is ', dashboardId);
    const newUrl = window.location.href.split('?')[0] + '?dashboardId=' + dashboardId;
    window.history.pushState({dashboardId: dashboardId}, '', newUrl);
	
	
}

document.addEventListener('DOMContentLoaded', (event) => {

    document.getElementById('searchBox').addEventListener('input', function(event) {
        searchReports(event.target.value, menuData);
    });
});


// Search Reports Function ---------------------------------------------------------------------------------------------------------
function searchReports(searchTerm, menuData) {
    var resultsDiv = document.getElementById('results');

    // Clear previous results
    resultsDiv.innerHTML = '';

    // Don't show any results if the search term is empty
    if (searchTerm === '') {
        resultsDiv.classList.remove('hasResults');
        return;
    }

    // Filter the menuData based on the search term
    var results = menuData.filter(function(item) {
        return item.REPORT_NAME.toLowerCase().includes(searchTerm.toLowerCase()) ||
           (item.KEYWORDS && item.KEYWORDS.toLowerCase().includes(searchTerm.toLowerCase()));
    });

    // If there are results, add the 'hasResults' class; otherwise, remove it
    if (results.length > 0) {
        resultsDiv.classList.add('hasResults');
    } else {
        resultsDiv.classList.remove('hasResults');
    }

    // For each result, create a link and add it to the results div
    results.forEach(function(item) {
        var link = document.createElement('a');
        link.href = '#';
        link.textContent = item.MENU_LEVEL_1 + ' > ' + item.MENU_LEVEL_2 + ' > ' + item.REPORT_NAME;
        link.onclick = function() {
            //console.log('Report link clicked');  // Debugging line
            // Update breadcrumb text
            var breadcrumb = document.getElementById('breadcrumb');
            //console.log(breadcrumb);  // Debugging line
            breadcrumb.textContent = item.MENU_LEVEL_1 + ' > ' + item.MENU_LEVEL_2 + ' > ' + item.REPORT_NAME;

            loadDashboard(item.REPORT_ID);

            // Clear the input box
            document.getElementById('searchBox').value = '';

            // Clear the results and remove the 'hasResults' class
            resultsDiv.innerHTML = '';
            resultsDiv.classList.remove('hasResults');

            return false;
        };
        resultsDiv.appendChild(link);
    });
}



    
  </code></pre>	


<!-- ------------------------------------------------------------ -->
	
<h2 id="php-section">PHP Code</h2>
<pre><code>
&lt;?php
    header(&#39;Content-Type: application/json&#39;);

    // Path to the CSV file
    $csvFile = &#39;omega_bi_menu.csv&#39;;
    
    // Open the CSV file
    $fileHandle = fopen($csvFile, &#39;r&#39;);
    
    // Initialize an array to hold our CSV data
    $data = [];
    
    // Fetch the CSV headers and trim any whitespace
    $headers = array_map(&#39;trim&#39;, fgetcsv($fileHandle));
    
    // Loop through the rest of the rows in the CSV file
    while (($row = fgetcsv($fileHandle)) !== false) {
        // Combine the headers with the row data
        $data[] = array_combine($headers, $row);
    }
    
    // Close the file handle
    fclose($fileHandle);
    
    // Output the data as JSON
    echo json_encode($data);
?&gt;
   
</code></pre>	

<!-- ------------------------------------------------------------ -->
	
<h2 id="application-section">App JavaScript Code</h2>
<pre><code>
const crypto = require('crypto');
const express = require('express');
const session = require('express-session');
const querystring = require('querystring');
const axios = require('axios');
const jwt = require('jsonwebtoken');
const { v4: uuidv4 } = require("uuid");
//const cors = require('cors');
const { createProxyMiddleware } = require('http-proxy-middleware');

const app = express();

const connectedAppId = process.env.TABLEAU_CLIENT_ID; //iss
const connectedAppSecretID = process.env.TABLEAU_CLIENT_SECRET; //kid
const connectedAppSecret = process.env.TABLEAU_SECRET_VALUE; //secret

// Define CORS options
//const corsOptions = {
//  origin: 'https://omega-bi.cisco.com', // Replace with the origin allowed to access your server
//  optionsSuccessStatus: 200 // Some legacy browsers (IE11, various SmartTVs) choke on 204
//};

// Set up CORS for your Express server
//app.use(cors(corsOptions));

app.use((req, res, next) => {
  res.header('Access-Control-Allow-Origin', '*');
  next();
});


app.get('/vizportal/api/web/v1/auth/embed/signin', (req, res) => {
  request(
    { url: 'https://tableau.cisco.com/vizportal/api/web/v1/auth/embed/signin' },
    (error, response, body) => {
      if (error || response.statusCode !== 200) {
        return res.status(500).json({ type: 'error', message: err.message });
      }

      res.json(JSON.parse(body));
    }
  )
});


// Trust all proxies - use with caution
app.set('trust proxy', true);

// Session middleware setup
app.use(session({
  secret: 'wrbJM0gMPKfXyy4c6o8+m52v/EBt21M6IufLMp1T+6k=', // A secret key used to sign the session ID cookie
  resave: false, 
  saveUninitialized: true, 
  cookie: { secure: true,
            httpOnly: true}
}));

function getCurrentTimestamp() {
  const now = new Date();
  return now.toTimeString().split(' ')[0]; // Gets the HH:MM:SS part of the toTimeString
}

function logWithTimestamp(...messages) {
  console.log(`[${getCurrentTimestamp()}]`, ...messages);
}

// Function to get Tableau Token

function getTableauToken(iss, kid, secret, userName) {
  const currentTime = Math.floor(Date.now() / 1000);
  const tokenExpiryInMinutes = 10;
  console.log('getTableauToken user =', userName);

  const payload = {
    "jti": uuidv4(),
    "aud": "tableau",
    "sub": userName,
    "scp": ["tableau:views:embed"],
    "nbf": currentTime - 100,
    "exp": currentTime + tokenExpiryInMinutes * 60
  };

  const header = {
    "alg": "HS256",
    "typ": "JWT",
    "kid": kid,
    "iss": iss  // Non-standard placement of 'iss' in the header
  };

  // Encode the JWT with the given secret key
  const jwtToken = jwt.sign(payload, secret, { header, noTimestamp: true });

  return jwtToken;
}

// simple utility function to do base64-url encoding
function base64urlEncode(buffer) {
  return buffer.toString('base64').replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
}

// Function to generate a random string for the code verifier
function generateCodeVerifier(length = 128) {
  const possibleCharacters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
  let verifier = '';
  for (let i = 0; i < length; i++) {
    verifier += possibleCharacters.charAt(Math.floor(Math.random() * possibleCharacters.length));
  }
  return verifier;
}

// Function to generate the code challenge from the code verifier
function generateCodeChallenge(verifier) {
  return base64urlEncode(crypto.createHash('sha256').update(verifier).digest());
  //return crypto.createHash('sha256').update(verifier).digest().toString('base64url');
}

// Function to redirect user to authorization endpoint
function redirectToAuthorizationEndpoint(req, res) {
  const codeVerifier = generateCodeVerifier();
  const codeChallenge = generateCodeChallenge(codeVerifier);

  // Store the code verifier in the session or a cookie to use later
  req.session.codeVerifier = codeVerifier; // Make sure you have session middleware set up
  console.log('Code Verifier: ', codeVerifier);
  console.log('Session Stored Code Verifier: ', req.session.codeVerifier);

  // Store the code challenge in the session to use later
  req.session.codeChallenge = codeChallenge;
  console.log('Session Stored Code Challenge: ', req.session.codeChallenge);

  const authParams = {
    response_type: 'code',
    client_id: 'DIQWROZS0QPEICM6FM8Q',
    redirect_uri: 'https://clpm-bi.cisco.com/sso/redirect', 
    scope: 'openid',
    code_challenge: codeChallenge,
    code_challenge_method: 'S256'
  };


  const authUrl = `https://sso-dbbfec7f.sso.duosecurity.com/oidc/DIQWROZS0QPEICM6FM8Q/authorize?${querystring.stringify(authParams)}`;

  // Redirect the user to the authorization endpoint
  res.redirect(authUrl);
}

// Define a route that initiates the PKCE flow---------------------------------------------------------------
// ----------------------------------------------------------------------------------------------------------
app.get('/auth', (req, res) => {
  logWithTimestamp('/auth fired.....................');
  // Save the returnUrl in the session before redirecting to the SSO server
  const returnUrl = req.query.returnUrl;
  req.session.returnUrl = returnUrl;
  console.log('Return Url Saved:', req.session.returnUrl);

  // Call the function to handle the redirect to the authorization endpoint
  redirectToAuthorizationEndpoint(req, res);
});

// Route that handles the redirect from the authorization server-----------------------------------------------------
// ------------------------------------------------------------------------------------------------------------------
app.get('/sso/redirect', async (req, res) => {
  // Extract the authorization code from the query string
  logWithTimestamp('/sso/redirect fired...................');
  const code = req.query.code;
	console.log('sso redirect code is:', req.query.code);

  // Prepare the data for the token exchange
  const tokenEndpoint = 'https://sso-dbbfec7f.sso.duosecurity.com/oidc/DIQWROZS0QPEICM6FM8Q/token';
  const clientId = 'DIQWROZS0QPEICM6FM8Q';
  const redirectUri = 'https://clpm-bi.cisco.com/sso/redirect';
  const codeVerifier = req.session.codeVerifier; // The code verifier you generated earlier
  console.log('Session Retrieved Code Verifier: ', codeVerifier);

  const postData = querystring.stringify({
    grant_type: 'authorization_code',
    client_id: clientId,
    redirect_uri: redirectUri,
    code: code,
    code_verifier: codeVerifier,
  });

  // Set up the POST request headers
  const config = {
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded'
    }
  };

  try {
    // Make the POST request to exchange the authorization code for an access token
    const response = await axios.post(tokenEndpoint, postData, config);
    console.log('Access Token:', response.data.access_token);
    req.session.accessToken = response.data.access_token;

    // Now that we have the access token, we get the user info
    const userinfoEndpoint = 'https://sso-dbbfec7f.sso.duosecurity.com/oidc/DIQWROZS0QPEICM6FM8Q/userinfo';


    // Set up the headers for the GET request
    const headers = {
        'Authorization': `Bearer ${response.data.access_token}`
    };

   // Make the GET request to retrieve the user information
   const userinfoResponse = await axios.get(userinfoEndpoint, { headers });
   console.log('User information:', userinfoResponse.data);
   console.log('User is:', userinfoResponse.data.user);

   // Store the user in the session
   req.session.user = userinfoResponse.data.user;
	      
   // Save the session explicitly to ensure the session
   // is saved before the next asynchronous operation or sending a response
   await new Promise((resolve, reject) => {
      req.session.save(err => {
        if (err) {
          console.error('Error saving the session:', err);
          reject(err);
        } else {
          resolve();
        }
      });
   });

   // Get the Tableau Token
   const token = getTableauToken(connectedAppId, connectedAppSecretID, connectedAppSecret, req.session.user);
   console.log("Generated JWT Token:", token);
 
   // Store the Tableau Token
   req.session.token = token;

   // Redirect the user
   const redirectUrl = req.session.returnUrl;
   res.redirect(redirectUrl);

  } catch (error) {
    // Handle any errors from either the token exchange or the userinfo request
    console.error('Error:', error.response ? error.response.data : error.message);
    res.status(500).send('Error processing the request');
  }
});


// Check if the user has a valid session---------------------------------------------------------------------------
// ----------------------------------------------------------------------------------------------------------------
app.get('/check-session', (req, res) => {
  logWithTimestamp('Check Session Fired............................................................');
	console.log('Cookies:', req.headers.cookie); // Logs the cookie header from the request
	console.log('req.session=',req.session);
	console.log('req.session.user=',req.session.user);
	console.log('req.session.token=', req.session.token);
  if (req.session && req.session.user) { 
    // The user is logged in, return a positive response
    res.json({ isValidSession: true, tableauToken: req.session.token });
  } else {
    // The user is not logged in, return a negative response
    res.json({ isValidSession: false });
  }
});

// Get new token----------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------------
app.get('/get-new-token', (req, res) => {
  logWithTimestamp('Get New Token Fired............................................................');
  // Get the Tableau Token
  if (typeof req.session.user !== 'undefined') {
    const token = getTableauToken(connectedAppId, connectedAppSecretID, connectedAppSecret, req.session.user);
    console.log("New Generated JWT Token:", token);

     // Store the Tableau Token
     req.session.token = token;
     res.json({tableauToken: req.session.token});
   } else {
     // req.session.user is undefined, handle the error
     console.error('req.session.user is undefined');
     // Send an appropriate error response
     res.status(400).json({ error: 'User session is not available. Authentication required.' });
   }

});

// Proxy endpoint
app.get('/tableau-api-proxy', (req, res) => {
  // URL to the Tableau JavaScript file
  logWithTimestamp('/tableau-api-proxy fired.....................');
  const tableauApiUrl = 'https://tableau.cisco.com/javascripts/api/tableau.embedding.3.latest.min.js';

  axios({
    method: 'get',
    url: tableauApiUrl,
    responseType: 'stream',
    timeout: 60000
  })
  .then(response => {
    response.data.pipe(res);
  })
  .catch(error => {
    console.error(error);
    res.status(500).send('Error occurred while fetching Tableau JavaScript API.');
  });
});


// Start the server
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`Server listening on port ${PORT}`);
});
   
</code></pre>	
	

</body>
</html>
